---
title: "DavFinalProj"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#libraries
library(tidyverse)
library(rgdal)        
library(ggplot2)
library(wesanderson)
library(RColorBrewer)
library(ggmap)

```

Problem Understanding: 
Until now gender statistics have been region neutral- they show LFPR, wage gaps etc country-wise or region-wise, but without any exploration into causal relationships behind trends. If there is a huge difference in the manner in which fertility rates & labor force participation rates are related in sub-saharan africa as opposed to norwegian countries, we don't pause to wonder why that could be. Throwing light into causal relationships if any, into how women belonging to different regions react to maternity policies can give us insights on how to improve labor force participation rates with strategic interventions depending on the regions. 

Graphic1: that shows how every indicator across the world has improved for women, except for LFPR

Graphic 2: (aim is to stress need to address this issue urgently. So, Before Graphic3, show how world economic growth has been slowing down and overlap this with a fall in LFPR as well)

Graphic3: that shows current GDP @ current LFPR vs GDP with LFPR at full potential

Graphic 4: Plot Rate of fall of LFPR in different zones: North America, Sub-Saharan Africa, South Asia, Western Europe, East Asia

Research Q: it is evident from Graphic3 that increasing women LFPR is vital to global economic interests. Why then, despite increasing standard of living, healthcare, opportunities and laws for ensuring safety, does LFPR fall? How different are the scenarios between developed and developing countries? Using bayesian modeling, we try to explore causalities between FLFPR and other development indicators: maternity leave, per capita income, education levels, fertility rates, percentage of wage compensated during maternity leave etc. 
Using our inference, we provide policy recommendations for possible interventions. 

###########################################################################        
Graphic1 : 
major indicators: female literacy, maternal mortality, female life-expectancy, Net primary enrollment rate (%), Net secondary enrollment rate (%), 

```{r}
setwd("~/Documents/GitHub/dav_final")

#graphic1
#LITERACY
YouthLiteracy=read.csv('GenderStatsData/graphic1/youth_literacy_15_24.csv',header = TRUE, sep=',')
length(unique(YouthLiteracy$Country)) #number of countries

#female literacy in 1995 
mean(YouthLiteracy[(YouthLiteracy$Year==min(YouthLiteracy$Year))&(YouthLiteracy$Sex=='Female'),]$Value)
#female literacy in 2016 
mean(YouthLiteracy[(YouthLiteracy$Year==max(YouthLiteracy$Year))&(YouthLiteracy$Sex=='Female'),]$Value)

#MATERNAL MORTALITY per 100,000 births
mortality=read.csv('GenderStatsData/graphic1/maternal_mortality.csv',header = TRUE, sep=',')
#in 1995 
mean(mortality[(mortality$Year==1995)&(mortality$Sex=='Female'),]$Value)
#in 2015 
mean(mortality[(mortality$Year==2015)&(mortality$Sex=='Female'),]$Value)

#EDUCATION 25+ 
uppersecondary=read.csv('GenderStatsData/graphic1/education_uppersecondary_25plus.csv',header = TRUE, sep=',')
#in 1995 
mean(uppersecondary[(uppersecondary$Year==1995)&(uppersecondary$Sex=='Female'),]$Value)
#in 2015 
mean(uppersecondary[(uppersecondary$Year==2015)&(uppersecondary$Sex=='Female'),]$Value)
```

STEP 2: data set exploration
```{r}
#import all relevant data dets and see heads.
setwd("~/Documents/GitHub/dav_final/GenderStatsData")
high_income=read.csv("flfpr_highincome.csv",sep=',',header=TRUE)
low_income=read.csv("flfpr_lowincome.csv",sep=',',header=TRUE)
pop= read.csv("population_total.csv", sep=',',header=TRUE, skip = 4)
ml_length <- read.csv("ml_length.csv",sep=',',header=TRUE,skip=2)
seatprop <- read.csv("seatproportion_national.csv",sep=',',header = TRUE,skip=2)
ml_wagespaid <- read.csv("ml_wagespaid.csv",sep=',',header=TRUE,skip = 2)
genderquota <- read.csv("voluntary_genderquota_parl.csv",sep=',',header=TRUE,skip=2)
#Share of female science technology engineering and mathematics graduates at tertiary level	
ger_tertiary <- read.csv("ger_tertiary.csv",sep=',',header=TRUE,skip=2)  
ger_secondary <- read.csv("ger_secondary_edu.csv",sep=',',header=TRUE)  
flfpr <- read.csv("FLFPR.csv",sep=',',header=TRUE,skip=4)
gdp <- read.csv("gdp.csv",sep=',',header=TRUE,skip=4)
gni <- read.csv("gni.csv",sep=',',header=TRUE,skip=4)

#selecting years 2000 to 2017 
#for [seatprop, ger_tertiary, ger_secondary], [flfpr, gdp, gni]
inds=c("seatprop", "ger_tertiary", "ger_secondary")
drops <- c("Age","Location","Occupation","LowerBound","UpperBound","Unit","Indicator.Name","OriginData","NatureData","Sex","Region","Country.Code")
years= c(2000:2017)
# for (i in 1:length(inds)) {
#     df=get(inds[i])
#     df=df[ , !(names(df) %in% drops)][,1:5]
# }
ger_tertiary=ger_tertiary[ ,!(names(ger_tertiary) %in% drops)][,1:3]
ger_secondary=ger_secondary[ , !(names(ger_secondary) %in% drops)][,1:3]
seatprop=seatprop[ , !(names(seatprop) %in% drops)][,1:3]
#doing this inside the forloop somehow doesn't work. will try again later.
ger_tertiary=ger_tertiary[which(ger_tertiary$Year>=2000),]
ger_tertiary=ger_tertiary[which(ger_tertiary$Year<2018),]
seatprop=seatprop[which(seatprop$Year>=2000),]
seatprop=seatprop[which(seatprop$Year< 2018),]
ger_secondary=ger_secondary[which(ger_secondary$Year>=2000),]
ger_secondary=ger_secondary[which(ger_secondary$Year<2018),]
colnames(ger_secondary)=c("Country","Year","indicator")
colnames(ger_tertiary)=c("Country","Year","indicator")
colnames(seatprop)=c("Country","Year","indicator")


#selecting years for [flfpr, gdp, gni]
drop_cols=c("Indicator.Name","Indicator.Code","Country.Code")
#why doesn't the for-loop work? doing it manually. -.-
flfpr=flfpr[,!names(flfpr) %in% drop_cols][,-c(4:42,61,62)]
flfpr=flfpr[,!names(flfpr) %in% c("X1960")]
gdp=gdp[,!names(gdp) %in% drop_cols][,-c(3:42,61,62)]
gni=gni[,!names(gni) %in% drop_cols][,-c(3:42,61,62)]
pop=pop[,!names(pop) %in% drop_cols][,-c(3:42,61,62)]

colnames(flfpr)=c("Country.Name","2000","2001","2002","2003","2004","2005","2006","2007","2008","2009","2010","2011","2012","2013","2014","2015","2016","2017")
colnames(gdp)=c("Country.Name","2000","2001","2002","2003","2004","2005","2006","2007","2008","2009","2010","2011","2012","2013","2014","2015","2016","2017")
colnames(gni)=c("Country.Name","2000","2001","2002","2003","2004","2005","2006","2007","2008","2009","2010","2011","2012","2013","2014","2015","2016","2017")
colnames(pop)=c("Country.Name","2000","2001","2002","2003","2004","2005","2006","2007","2008","2009","2010","2011","2012","2013","2014","2015","2016","2017")

flfpr=flfpr[1:(length(flfpr)-1)]
gdp=gdp[1:(length(gdp)-1)]
gni=gni[1:(length(gni)-1)]
pop=pop[1:(length(pop)-1)]
#have to melt the last three so that years are rows instead of separate columns. 
library(reshape2)

#can't be done in a forloop, because you have to store the molten dataframes under different names

molten.flfpr=melt(flfpr, id.vars = c("Country.Name"))
molten.gdp=melt(gdp, id.vars = c("Country.Name"))
molten.gni=melt(gni, id.vars = c("Country.Name"))
molten.pop=melt(pop, id.vars = c("Country.Name"))

colnames(molten.flfpr)=c("Country","Year","indicator")
colnames(molten.gdp)=c("Country","Year","indicator")
colnames(molten.gni)=c("Country","Year","indicator")
colnames(molten.pop)=c("Country","Year","indicator")

#the remaining: [genderquota, ml_wagespaid, ml_length]
ml_wagespaid1=ml_wagespaid[,!names(ml_wagespaid) %in% c("Indicator.Name","Footnote","Measure.Name","Data.Unit","Country.Code","Region","Measure.Value")]
colnames(ml_wagespaid1)=c("Country","indicator")

genderquota1=genderquota[,!names(genderquota) %in% c("Indicator.Name","Footnote","Measure.Name","Data.Unit","Country.Code","Region","Year")]
head(genderquota1)
colnames(genderquota1)=c("Country","indicator")

ml_length1=ml_length[,!names(ml_length) %in% c("Indicator.Name","Footnote","Measure.Name","Data.Unit","Country.Code","Measure.Value","Region")]
colnames(ml_length1)=c("Country","indicator")


#choosing countries we need from HighIncome and LowIncome countries
high_income_countries=subset(high_income,select=("Country.Name"))
low_income_countries=subset(low_income,select=("Country.Name"))
req_countries=rbind(high_income_countries,low_income_countries)
a=unique(req_countries$Country.Name)

#function to select countries
# SelectCountries <- function(df) {
#         # Remove entries from regions of aggregated countries
#         df <- subset(df,df$Country %in% a)
#         return(df)
# }
# indicators=c("seatprop","ger_tertiary","ger_secondary","molten.flfpr","molten.gdp","molten.gni","molten.pop","ml_length1","ml_wagespaid1","genderquota1")
# for(i in (1:length(indicators))){
#    SelectCountries(get(indicators[i]))
# }

seatprop=subset(seatprop,seatprop$Country %in% a)
indicator=rep("seatprop",length(seatprop[,1]))
seatprop=cbind(seatprop,indicator)

ger_tertiary=subset(ger_tertiary,ger_tertiary$Country %in% a)
indicator=rep("ger_tertiary",length(ger_tertiary[,1]))
ger_tertiary=cbind(ger_tertiary,indicator)

ger_secondary=subset(ger_secondary,ger_secondary$Country %in% a)
indicator=rep("ger_secondary",length(ger_secondary[,1]))
ger_secondary=cbind(ger_secondary,indicator)

molten.flfpr=subset(molten.flfpr,molten.flfpr$Country %in% a)
indicator=rep("molten.flfpr",length(molten.flfpr[,1]))
molten.flfpr=cbind(molten.flfpr,indicator)

molten.gdp=subset(molten.gdp,molten.gdp$Country %in% a)
indicator=rep("molten.gdp",length(molten.gdp[,1]))
molten.gdp=cbind(molten.gdp,indicator)

molten.gni=subset(molten.gni,molten.gni$Country %in% a)
indicator=rep("molten.gni",length(molten.gni[,1]))
molten.gni=cbind(molten.gni,indicator)

molten.pop=subset(molten.pop,molten.pop$Country %in% a)
indicator=rep("molten.pop",length(molten.pop[,1]))
molten.pop=cbind(molten.pop,indicator)

ml_length1=subset(ml_length1,ml_length1$Country %in% a)
indicator=rep("ml_length1",length(ml_length1[,1]))
ml_length1=cbind(ml_length1,indicator)

ml_wagespaid1=subset(ml_wagespaid1,ml_wagespaid1$Country %in% a)
indicator=rep("ml_wagespaid1",length(ml_wagespaid1[,1]))
ml_wagespaid1=cbind(ml_wagespaid1,indicator)

genderquota1=subset(genderquota1,genderquota1$Country %in% a)
indicator=rep("genderquota1",length(genderquota1[,1]))
genderquota1=cbind(genderquota1,indicator)

str_of_dataframes=c("seatprop","ger_tertiary","ger_secondary","molten.flfpr","molten.gdp","molten.gni","molten.pop")
main_df = data.frame()

    for (indicators in str_of_dataframes) {
        main_df = rbind(main_df, get(indicators))
    }

main_df=subset(main_df,main_df$Country %in% a)
colnames(main_df)=c("Country","Year","value","variable")
head(main_df)
main_nona= main_df[!is.na(main_df$value),]
sum(is.na(main_nona$Value))

library(reshape2)
main_cast=dcast(main_nona, Country+Year~variable, sum)
main_cast_mean=dcast(main_nona, Country+Year~variable, mean)
head(main_cast_mean)
write.csv(main_cast_mean,"main_cast.csv")

#type+year~variable,sum
#number of countries are the same! 
#now we proceed to melt again

#correlation plot 
library(ggplot2)


```










This is the template we could use to clean the data: (provided earlier)
```{r}
# find the right variables
my_var = c("IT.NET.BBND","NY.GDP.MKTP.CD","SP.POP.TOTL","AG.LND.TOTL.K2","IS.RRS.TOTL.KM")
# subset the data
country_data = subset(mydata,mydata$Country.Code %in% country_code$V1)
indicator_data = subset(country_data,country_data$Indicator.Code %in% my_var)

main_idx <- match(c("Country.Code","Indicator.Code","X2013"), names(mydata))
urban_idx <- match(c("Country.Code","Indicator.Code","X2010"), names(mydata))
indicator_data = indicator_data[,main_idx]

names(indicator_data) <- c("Country","Indicator","Value")

urban_data = subset(country_data,country_data$Indicator.Code %in% "AG.LND.TOTL.UR.K2")
urban_data = urban_data[,urban_idx]

names(urban_data) <- c("Country","Indicator","Value")
combined_data = rbind(indicator_data,urban_data)

combined_melt = melt(combined_data, id=c("Country","Indicator","Value"))
combined_cast=cast(combined_melt, Country  ~ Indicator, value = 'Value')

bbdata <- na.omit(combined_cast)
dim(bbdata)
names(bbdata) <- c("country","agri_land","urban","rail","bbnd","gdp","pop")
row.names(bbdata) <- 1:nrow(bbdata)

plot(bbdata$gdp,bbdata$bbnd,log='xy')
```

this is the template use by Jason for their project. could directly be applied to us
```{r}
 getdata = function() {
    ### getdata.R
    ## 
    ## This file imports and cleans the data for all the variables and indicators we aim to examine.
    ## It then considates all of the data in one dataframe with rows sep

    library(reshape)

    # Import data, which is all from the World Bank Indicators database
    age_dependency_old <- read.csv("data/API_SP.POP.DPND.OL_DS2_en_csv_v2_10184911.csv",sep=',',header=TRUE,skip=4)
    age_dependency_young <- read.csv("data/API_SP.POP.DPND.YG_DS2_en_csv_v2_10199819.csv",sep=',',header=TRUE,skip=4)
    age_dependency_ratio <- read.csv("data/API_SP.POP.DPND_DS2_en_csv_v2_10188478.csv",sep=',',header=TRUE,skip=4)
    GDP <- read.csv("data/API_NY.GDP.MKTP.CD_DS2_en_csv_v2_10203569.csv",sep=',',header=TRUE,skip=4)
    health_expenditure_capita <- read.csv("data/API_SH.XPD.EHEX.PC.CD_DS2_en_csv_v2_10203894.csv",sep=',',header=TRUE,skip=4)
    health_expenditure <- read.csv("data/API_SH.XPD.CHEX.GD.ZS_DS2_en_csv_v2_10183765.csv",sep=',',header=TRUE,skip=4)
    household_consumption <- read.csv("data/API_NE.CON.PRVT.CD_DS2_en_csv_v2_10184156.csv",sep=',',header=TRUE,skip=4)
    GINI <- read.csv("data/API_SI.POV.GINI_DS2_en_csv_v2_10181010.csv",sep=',',header=TRUE,skip=4)
    life_expectency_birth <- read.csv("data/API_SP.DYN.LE00.IN_DS2_en_csv_v2_10181296.csv",sep=',',header=TRUE,skip=4)
    total_popuation <- read.csv("data/API_SP.POP.TOTL_DS2_en_csv_v2_10203548.csv",sep=',',header=TRUE,skip=4)

    # Since all the data is from the same source and comes in the same format, we can clean it easily together.
    # Create a list of all the names of the dataframes and the generic header names
    str_of_dataframes <- c('age_dependency_old','age_dependency_young','age_dependency_ratio','GDP','health_expenditure_capita','health_expenditure','household_consumption','GINI','life_expectency_birth','total_popuation')
    header_names <- c('Country_Name', 'Country_Code', 'Indicator_Name','Indicator_Code',1960:2017) # Note, these year columns will be turned into strings

    ## Also read in a metadata file we can use to remove aggregated countries (regions)
    country_code <- read.csv("data/Metadata_Country.csv",sep=",",header=TRUE,skip=0)
    # country_code = country_code[,c('Country.Code','TableName')] # Drop the irrelevant columns
    # names(country_code) = c('Code','Country Name')
    colnames(country_code)[1] <-"CountryCode" #change the name of the first row
    country_code <- country_code[!(country_code$Region == ""), ] #keep only countries and skip aggregated inputs

    ## Functions to clean the data
    CleanDataFrame <- function(D) {
        # This simply ensures consistency
        D[length(D)] <- NULL # Delete the last column, it is empty
        colnames(D) <- header_names # Change the headernames to be the same
        return(D)
    }

    OnlyCountries <- function(D) {
        # Remove entries from regions of aggregated countries
        D <- subset(D,D$Country_Code %in% country_code$CountryCode)
        return(D)
    }

    # Actually clean the data: Walk through the list of indicators and clean it
    for (i in 1:length(str_of_dataframes)) {
        assign(str_of_dataframes[i], CleanDataFrame(get(str_of_dataframes[i])))
        assign(str_of_dataframes[i], OnlyCountries(get(str_of_dataframes[i])))
    }

    # Combine all indicators into one DataFrame
    AllInds = data.frame()

    for (indicator in str_of_dataframes) {
        # print(names(get(indicator)))
        AllInds = rbind(AllInds, get(indicator))
    }

    # Reshape the combined DataFrame

    AllInds_melted = melt(AllInds, id = c('Country_Name','Country_Code','Indicator_Name','Indicator_Code'), variable_name='Year')
    AllInds_cast = cast(AllInds_melted, Country_Name + Year ~ Indicator_Code)
    return(AllInds_cast)
 }
```
 
code used to plot correlations
```{r}
### This script plots correlations between the age dependency ratio and other indicators
## Deprecated? - Jason

library(ggplot2)

# These are the indicators we are concerned about
indicatorsVect = c(
    "NY.GDP.MKTP.CD","SH.XPD.EHEX.PC.CD","SH.XPD.CHEX.GD.ZS",
    "NE.CON.PRVT.CD","SI.POV.GINI","SP.DYN.LE00.IN","SP.POP.TOTL")

# Create exploratory plots
for (indicator in indicatorsVect) { # Ignore the three age dependency indicators
    # Ideally, subplot this

    # if countries are separated (maybe they should be?), then call maybe subset each country?
    # plot(unlist(AllInds_cast['SP.POP.DPND']),unlist(AllInds_cast[indicator])) <-- group by country

    # ggplot2
    plot <- ggplot(data = AllInds_cast, aes(x = SP.POP.DPND, y = get(indicator), colour = Year) ) + geom_point() # colour can be by 'Country_Name' too
    plot <- plot + guides(colour = FALSE) # Turn off the legend since it will get too confusing with all countries
    plot + scale_y_log10() # (GDP looks weird! Plot in log10 to see if there is something interesting...)
    plot + ylab(paste0(indicator)) # Run this instead of 'get(indicator)', which is the default output
    # We should instead match these with the actual indicator names
    saveName = sprintf('figures/%s.png',gsub('\\.','',indicator) )
    ggsave(saveName)
}

## Grammar Validation and Examples
test = subset(AllInds_cast, Country_Name == c('Canada','Netherlands') )
test2 = AllInds_cast[ which(AllInds_cast['Country_Name'] == 'Canada'), ])

p0 = ggplot(data = test, aes(x = Year, y = NY.GDP.MKTP.CD, colour = Year) ) + geom_point()
p0+guides(colour=FALSE)
```

